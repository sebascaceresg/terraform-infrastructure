version: 2.1

# Executors #
executors:
  terraform:
    docker:
      - image: hashicorp/terraform:1.11.3
    resource_class: small

# Parameters #
parameters:
  gcp-hub-project:
    type: boolean
    default: false
  gcp-my-projects:
    type: boolean
    default: false

# Commands #
commands:
  config-known-hosts:
    steps:
      - run:
          command: |
            echo 'github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCj7ndNxQowgcQnjshcLrqPEiiphnt+VTTvDP6mHBL9j1aNUkY4Ue1gvwnGLVlOhGeYrnZaMgRK6+PKCUXaDbC7qtbW8gIkhL7aGCsOr/C56SJMy/BCZfxd1nWzAOxSDPgVsmerOBYfNqltV9/hWCqBywINIR+5dIg6JTJ72pcEpEjcYgXkE2YEFXV1JHnsKgbLWNlhScqb2UmyRkQyytRLtL+38TGxkxCflmO+5Z8CSSNY7GidjMIZ7Q4zMjA2n1nGrlTDkzwDCsw+wqFPGQA179cnfGWOWRVruj16z6XyvxvjJwbz0wQZ75XK5tKSb7FNyeIEs4TT4jk+S4dhPeAUC5y+bDYirYgM4GC7uEnztnZyaVWQ7B381AK4Qdrwt51ZqExKbQpTUNn+EjqoTwvqNj4kqx5QUCI0ThS/YkOxJCXmPUWZbhjpCg56i+2aB6CmK2JGhn57K5mj0MNdBXA4/WnwH6XoPWJzK5Nyu2zB3nAZp+S5hpQs+p1vN1/wsjk=
            ' >> ~/.ssh/known_hosts

# Jobs #
jobs:
  tf-credentials:
    executor: terraform
    steps:
      - run: mkdir -p /tmp/workspace/.terraform.d
      - run: echo "credentials \"app.terraform.io\" {token = \"$TERRAFORM_TOKEN\"}" > /tmp/workspace/.terraform.d/credentials.tfrc.json
      - persist_to_workspace:
          root: /tmp
          paths:
            - workspace
  tf-validate-plan:
    executor: terraform
    parameters:
      dir: { type: string }
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - add_ssh_keys:
          fingerprints:
            - "SHA256:w9BpElALXAxQQKMHzLd0wYDEdqsuLCX49OAS35SDr9s"
      - config-known-hosts
      - checkout
      - run: terraform fmt -check
      - run: terraform -chdir=<< parameters.dir >> init
      - run: terraform -chdir=<< parameters.dir >> validate
      - run: terraform -chdir=<< parameters.dir >> plan

workflows:
  hub-project-infrastructure:
    when: << pipeline.parameters.gcp-hub-project >>
    jobs:
      - tf-credentials:
          context: terraform
      - tf-validate-plan:
          context: terraform
          dir: gcp-projects/hub-project
          requires:
            - tf-credentials:
                - success
