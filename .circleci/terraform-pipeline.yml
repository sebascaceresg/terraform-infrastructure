version: 2.1

# Executors #
executors:
  terraform:
    docker:
      - image: hashicorp/terraform:1.11.3
    resource_class: small

# Parameters #
parameters:
  gcp-hub-project:
    type: boolean
    default: false
  gcp-my-projects:
    type: boolean
    default: false

# Jobs #
jobs:
  tf-credentials:
    executor: terraform
    context: terraform
    steps:
      - run: mkdir -p ~/.terraform.d
      - run: echo "credentials \"app.terraform.io\" {token = \"$TERRAFORM_TOKEN\"}" > ~/.terraform.d/credentials.tfrc.json
      - persist_to_workspace:
          root: ~/.terraform.d
          paths:
            - credentials.tfrc.json
  tf-validate-plan:
    executor: terraform
    parameters:
      dir: { type: string }
    steps:
      - attach_workspace:
          at: ~/.terraform.d
      - checkout
      - run: cd << parameters.dir >>
      - run: terraform fmt -check
      - run: terraform validate
      - run: terraform plan

workflows:
  hub-project-infrastructure:
    when: << pipeline.parameters.gcp-hub-project >>
    jobs:
      - tf-credentials
      - tf-validate-plan:
          dir: gcp-projects/hub-project
